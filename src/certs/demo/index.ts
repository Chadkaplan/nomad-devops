import * as fs from "fs";
import { secrets } from "../../utils/demo/secrets";
import * as tempy from "tempy";

export const APPLE_CA_CERTIFICATE = `
-----BEGIN CERTIFICATE-----
  MIIEIjCCAwqgAwIBAgIIAd68xDltoBAwDQYJKoZIhvcNAQEFBQAwYjELMAkGA1UE
BhMCVVMxEzARBgNVBAoTCkFwcGxlIEluYy4xJjAkBgNVBAsTHUFwcGxlIENlcnRp
ZmljYXRpb24gQXV0aG9yaXR5MRYwFAYDVQQDEw1BcHBsZSBSb290IENBMB4XDTEz
MDIwNzIxNDg0N1oXDTIzMDIwNzIxNDg0N1owgZYxCzAJBgNVBAYTAlVTMRMwEQYD
VQQKDApBcHBsZSBJbmMuMSwwKgYDVQQLDCNBcHBsZSBXb3JsZHdpZGUgRGV2ZWxv
cGVyIFJlbGF0aW9uczFEMEIGA1UEAww7QXBwbGUgV29ybGR3aWRlIERldmVsb3Bl
ciBSZWxhdGlvbnMgQ2VydGlmaWNhdGlvbiBBdXRob3JpdHkwggEiMA0GCSqGSIb3
DQEBAQUAA4IBDwAwggEKAoIBAQDKOFSmy1aqyCQ5SOmM7uxfuH8mkbw0U3rOfGOA
YXdkXqUHI7Y5/lAtFVZYcC1+xG7BSoU+L/DehBqhV8mvexj/avoVEkkVCBmsqtsq
Mu2WY2hSFT2Miuy/axiV4AOsAX2XBWfODoWVN2rtCbauZ81RZJ/GXNG8V25nNYB2
NqSHgW44j9grFU57Jdhav06DwY3Sk9UacbVgnJ0zTlX5ElgMhrgWDcHld0WNUEi6
Ky3klIXh6MSdxmilsKP8Z35wugJZS3dCkTm59c3hTO/AO0iMpuUhXf1qarunFjVg
0uat80YpyejDi+l5wGphZxWy8P3laLxiX27Pmd3vG2P+kmWrAgMBAAGjgaYwgaMw
HQYDVR0OBBYEFIgnFwmpthhgi+zruvZHWcVSVKO3MA8GA1UdEwEB/wQFMAMBAf8w
HwYDVR0jBBgwFoAUK9BpR5R2Cf70a40uQKb3R01/CF4wLgYDVR0fBCcwJTAjoCGg
H4YdaHR0cDovL2NybC5hcHBsZS5jb20vcm9vdC5jcmwwDgYDVR0PAQH/BAQDAgGG
MBAGCiqGSIb3Y2QGAgEEAgUAMA0GCSqGSIb3DQEBBQUAA4IBAQBPz+9Zviz1smwv
j+4ThzLoBTWobot9yWkMudkXvHcs1Gfi/ZptOllc34MBvbKuKmFysa/Nw0Uwj6OD
Dc4dR7Txk4qjdJukw5hyhzs+r0ULklS5MruQGFNrCk4QttkdUGwhgAqJTleMa1s8
Pab93vcNIx0LSiaHP7qRkkykGRIZbVf1eliHe2iK5IaMSuviSRSqpd1VAKmuu0sw
ruGgsbwpgOYJd+W+NKIByn/c4grmO7i77LpilfMFY0GCzQ87HUyVpNur+cmV6U/k
TecmmYHpvPm0KdIBembhLoz2IYrF+Hjhga6/05Cdqa3zr/04GpZnMBxRpVzscYqC
tGwPDBUf
-----END CERTIFICATE-----
`;

export async function getWWDRCert() {
    return APPLE_CA_CERTIFICATE;
}

const CERTS = {
    "pass.com.ndudfield.nfc": `
-----BEGIN CERTIFICATE-----
MIIGJjCCBQ6gAwIBAgIICjy8HURYYEQwDQYJKoZIhvcNAQELBQAwgZYxCzAJBgNV
BAYTAlVTMRMwEQYDVQQKDApBcHBsZSBJbmMuMSwwKgYDVQQLDCNBcHBsZSBXb3Js
ZHdpZGUgRGV2ZWxvcGVyIFJlbGF0aW9uczFEMEIGA1UEAww7QXBwbGUgV29ybGR3
aWRlIERldmVsb3BlciBSZWxhdGlvbnMgQ2VydGlmaWNhdGlvbiBBdXRob3JpdHkw
HhcNMTgwOTE0MDQyODIzWhcNMTkxMDE0MDQyODIzWjCBmTEmMCQGCgmSJomT8ixk
AQEMFnBhc3MuY29tLm5kdWRmaWVsZC5uZmMxNjA0BgNVBAMMLVBhc3MgVHlwZSBJ
RCB3aXRoIE5GQzogcGFzcy5jb20ubmR1ZGZpZWxkLm5mYzETMBEGA1UECwwKUTMz
OFVZR0ZaODEVMBMGA1UECgwMRmxvbWlvLCBJbmMuMQswCQYDVQQGEwJVUzCCASIw
DQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAIWlH0R03EtGoIWk55P+GbZ4SNvy
Jx3/0+AIWUyNo3vaB3OLKYMJrCaxx0nm4Zz02DFWtpXNKKwvtJ5TpbwkVsfC3RKo
rgA1UBid0l7unEaarH4TUfNhDov/321XeZgsPfbEoVcBijRwE0uQFuL8y1hKTBsj
hIabUX17E5sM3eYt+kBpw1MdPddz0XEO3RcYo5ei/KCBexaz3WFOwJ5JueKSOlrd
FPAKnNya8N04SyLZY7ry3+xx/5UObRLgSTt/v1mpCNG7WzkTgKkik94IpsSOFKss
7hQowL++hyuPlVXfgAquExvilcraBTYlX5G178KtfORTS0GfC73EWhsaDPUCAwEA
AaOCAnEwggJtMAkGA1UdEwQCMAAwHwYDVR0jBBgwFoAUiCcXCam2GGCL7Ou69kdZ
xVJUo7cwPwYIKwYBBQUHAQEEMzAxMC8GCCsGAQUFBzABhiNodHRwOi8vb2NzcC5h
cHBsZS5jb20vb2NzcDAzLXd3ZHIwMjCCARwGA1UdIASCARMwggEPMIIBCwYJKoZI
hvdjZAUBMIH9MIHDBggrBgEFBQcCAjCBtgyBs1JlbGlhbmNlIG9uIHRoaXMgY2Vy
dGlmaWNhdGUgYnkgYW55IHBhcnR5IGFzc3VtZXMgYWNjZXB0YW5jZSBvZiB0aGUg
dGhlbiBhcHBsaWNhYmxlIHN0YW5kYXJkIHRlcm1zIGFuZCBjb25kaXRpb25zIG9m
IHVzZSwgY2VydGlmaWNhdGUgcG9saWN5IGFuZCBjZXJ0aWZpY2F0aW9uIHByYWN0
aWNlIHN0YXRlbWVudHMuMDUGCCsGAQUFBwIBFilodHRwOi8vd3d3LmFwcGxlLmNv
bS9jZXJ0aWZpY2F0ZWF1dGhvcml0eTAeBgNVHSUEFzAVBggrBgEFBQcDAgYJKoZI
hvdjZAQOMDAGA1UdHwQpMCcwJaAjoCGGH2h0dHA6Ly9jcmwuYXBwbGUuY29tL3d3
ZHJjYS5jcmwwHQYDVR0OBBYEFAdjnr8hfPyee+NUBbpUlCsugQIzMAsGA1UdDwQE
AwIHgDAQBgoqhkiG92NkBgMCBAIFADAmBgoqhkiG92NkBgEQBBgMFnBhc3MuY29t
Lm5kdWRmaWVsZC5uZmMwJgYKKoZIhvdjZAYBGgQYDBZwYXNzLmNvbS5uZHVkZmll
bGQubmZjMA0GCSqGSIb3DQEBCwUAA4IBAQAKy0RIS9qVtsRLs9QEpCY1XwaQ3lbk
LSkUyYBcOZFZ3s/En8zE8UP86mqH8FcjoPyxAtVZLLaAofwMvnno9184isADUr5D
hU8TPvuNAzZIatsBKUvheSGBTS3Siy2CdDoUWuEgnb35+UKheZwq4naJ7yL5YJkN
rsk0CgbJL1exMkDftnu1/LaqXmIWsF2JsttY339KfumXIOy+oq91NfGmUyDy8hZL
x833r5A34mkBQzY1qf2gmWMoj58BsfourceUhwp7xgrbUcWFGx9upg+FkAUeP86z
LPf0QAXuL/YMOwedYR8pO1XJBTCxFnA/On9j0f/zGrP1sfMTHFicrthf
-----END CERTIFICATE-----
-----BEGIN ENCRYPTED PRIVATE KEY-----
MIIFHzBJBgkqhkiG9w0BBQ0wPDAbBgkqhkiG9w0BBQwwDgQICX9zxhfopG8CAggA
MB0GCWCGSAFlAwQBAgQQrwZxeYTueP9GyB/KwxfPhASCBNCvnroOo9rWIPgAnnCs
Q06Q352etzNriyZ/hdTAa2tXpr7lqv7OOX4L3akZAlyVN1CVFCnov2GFZi5VTzRI
sO7NAodhpWbBuHM3NeaYd36v0WjsY3nVkFzAK0C+FDUtARcIjvw458fq7k7685Sp
1p8VJ5EE2h7tx937qL/1+8ISlnKgU+45hU9fNVG6M3yPc82Vqp9/EKO9mWhuqAxO
cA4W8dIdZlHqD5wsSbpPE4ibQEMRugddc+uxs08dffLHH9D7o+44F4hy3aSm6et5
l13m/XRmQcqOCgHNj21jVbzC3ZwIHH4X43zBrw4hfk4ZxCrnIxBmr37z2qNCb7Hl
3wG6TyuyPXnktmT5WM1n5g0X7f/Uwx/i1KWlbjP1aPI9EbNQQTDEPt1kWwESt3CD
n9gY011cj0JMzgBgQdmUjyyov7bbaj47x+yC7C4Tg4v+5q1TZZ4ROyDtiddauDlE
UjO7bBmrRfEoJrzU7lnRWvXIAfwgMtxE/lmQIgMtdO7ZOzbglHA49eqaKeNXCcEH
6Fes0GRD6b1dqphFprESTUyhAhoNiIWjlhVimNRHu4P+dXUEgbCf2seNnQn+fRtS
JwP+ePuCgKX9BSHpv2tC85mJYnQhwBwWO+h3K6LEDjFS/02RBKlhygftzWJNzKD3
DwVchbARPI0huVQE5thUjWAbtx8ueCw+oN0UrdKii3ziKaDqfgmbzb0/OXse+qXv
5c3imAe6PTxZiD236V9jwV1M0i4N4pHEA9SNGkth9thGB/HUl7NFq2eSanblMmjj
tklVThfepKDKpVyrY4YsF0y5oorEaRmz9s6FUDYw1iMzZYWi5InWw62VSDf2FVzi
r3zjURuKJ6wmgcfacVwDPONCnzdOKA1K7UhSLy59ssKYy4VPHXty7B64jNFqu91o
lTp4fBjY3eyoeNxsJmZ/Tygj8Rpq/W36EOcU+46WFhKAD80uUvmGCHpfxXWnRAiY
f1LTwYhKALi5/T1wd4USuUQnpJLwkuAn0MUqVm9IwjoDVghLG6HMzvUK8RGZKzvQ
8awy+VryIf2AuIcAj+HzrMbS7FNjJy4R0YRyimKaiTHIJhJBNSVvPCawifh8dauh
NydNrH8XOBCXi5xzrctxWUheg65Uw2VHuQmW1PEPdNm2z/du+UxUp2NMLCJb2+Qj
byoDw1XGRhE+68jMVC2qv9m0hlLIblif5WWEmt+VES8RnKOoVWbBFOEx2aPsg6EV
GmlWhSn0qv7J3Dicn36A2lbtHwgKJqUvHlWChgIh4xL/6Ap9IqGd+NngK5ufmjto
u3SQUfRSJP6n69MON1DJMVq88aGll7a3IUiu3IvyBB2uFHgDRQPi+b1q7Gxr1P7T
B9sSGPyQfYxa9g/DjgL1BOdXDJiw2nwfR6UvkkEWXPTE5HIfoCrsevjP8eO/1+PL
G1DCGh+mT6Ikirl7tRIslX8nm0v9uHhB50Q4ImtxFWkzHvsDmuX21tjiZWSpt3+b
LH612RFZy93pTUISp5icPoMa2uSBhMfe42kW2LwN8hz9oxRriKwYuP9S238YeRz+
DX0WzPYUdwYWXkYq11kRvaEY9t9o2WuZY77tXZTwawcVDsTbRG7f61fesSE18enW
Ke2E6jrIgWixLa2tENICczYdKA==
-----END ENCRYPTED PRIVATE KEY-----`
};

export const APPLE_CA_CERTIFICATE_PATH = tempy.file();
fs.writeFileSync(APPLE_CA_CERTIFICATE_PATH, APPLE_CA_CERTIFICATE);

const CERT_PATHS = {};
Object.keys(CERTS).forEach(passTypeId => {
    const fn = (CERT_PATHS[passTypeId] = tempy.file());
    fs.writeFileSync(fn, CERTS[passTypeId]);
});

export async function getCertPathAndPassPhrase(passTypeIdentifier: string) {
    const resolvedSecrets = await secrets;
    const passPhrase = resolvedSecrets[passTypeIdentifier];

    if (!passPhrase) {
        throw new Error(`Dont have passPhrase for ${passTypeIdentifier}`);
    }

    return [passPhrase, CERT_PATHS[passTypeIdentifier]];
}

process.on("exit", () => {
    const cleanups = Object.values(CERT_PATHS).concat(
        APPLE_CA_CERTIFICATE_PATH
    );
    cleanups.forEach(fs.unlinkSync);
    console.log("deleted", cleanups);
});
